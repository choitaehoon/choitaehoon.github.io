---
title: 인스타그램 피드를 어떻게 하면 빠르게 클라이언트에 반환할 수 있을까?
date: 2020-12-01 18:50:00 
---

### 배경

인스타그램 유저들은 인플루언서의 피드를 조회하는 경우가 잦습니다. 이러한 상황에서 조회했던 피드를 다시 데이터베이스에 가져오는 것은
비효율적입니다. 그렇다면 어떻게 해야 빠르고 효율적으로 클라이언트에 반환할 수 있을까? 라는 고민이 생깁니다. 아래의 글을 살펴보면서
해결했던 과정에 대해 공유하려 합니다.

### JPA 1차 캐싱

![image](https://user-images.githubusercontent.com/33123391/101153546-f121fd00-3667-11eb-9671-6fd22570c77c.png)

JPA는 영속 컨테스트 안에 1차 캐시가 존재합니다. 1차 캐시는 트랜잭션이 시작되고 종료될 때까지만 유효한 굉장히 짧은 캐시레이어이기 때문에
인스타그램 특정 유저에 대한 피드를 조회하는 것은 적합하지 않았습니다.

### JPA 2차 캐싱

![인스타그램 피드 캐시 그림](https://user-images.githubusercontent.com/33123391/102688436-01c29d80-423a-11eb-9981-01888dcd1b92.png)

JPA 2차 캐싱은 값 비싼 데이터베이스의 호출을 방지하고 어플리케이션 범위의 캐시를 지원하는데 종료될 때 까지 유지하여 성능을 향상시킵니다.
하지만 서버를 확장함에 따라 로컬에 유지하므로 각각의 서버에 데이터 캐시된 데이터가 다르므로 합리적이지 못합니다.
유저가 WAS1로 접속하고 해당 어플리케이션에 캐시를 적용한 다음 다른 유저가 
WAS2, WAS3으로 접속했다면 WAS1에 있던 캐시는 사용을 하지 못하는 문제가 있습니다.

### Redis
이러한 문제로 인해 레디스 서버를 사용하기로 생각했습니다. 현재 세션 레디스 서버가 있긴한데 레디스는 싱글스레드 이기 때문에 같이
사용하면 처리량에 한계가 금방와서 분리했습니다.

참고 문서
* https://cupjoo.github.io/%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8
* https://docs.oracle.com/javaee/6/tutorial/doc/gkjio.html